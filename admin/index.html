<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GTFS Admin — Feeds & Overrides</title>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 720px; margin: 32px auto; padding: 0 16px; }
  .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
  label { display: block; margin: 12px 0 6px; font-weight: 600; }
  input[type="password"], input[type="text"], textarea { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; }
  button { padding: 8px 14px; border-radius: 8px; border: 1px solid #d1d5db; cursor: pointer; background: white; }
  button.primary { background: #0ea5e9; color: white; border-color: #0284c7; }
  .muted { color: #6b7280; font-size: 13px; }
  pre { background: #f8fafc; padding: 12px; border-radius: 8px; overflow: auto; }
</style>

<h1>GTFS Admin — Upload <code>overrides.json</code></h1>
<p class="muted">This commits to your GitHub repo and triggers the nightly Action.</p>

<div class="card">
  <form id="uploader">
    <label>Admin key</label>
    <input type="password" id="key" placeholder="Your ADMIN_KEY" required />

    <label>Feed</label>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="feedSelect" style="flex:1 1 260px;"></select>
      <button type="button" id="refreshFeeds">Reload</button>
    </div>
    <p class="muted">Pick an existing feed or create a new one below.</p>

    <div class="card" style="margin:12px 0;">
      <strong>Add / Update feed</strong>
      <label>Feed slug</label>
      <input type="text" id="feedSlug" placeholder="e.g. flixbus" />
      <label>Feed URL</label>
      <input type="text" id="feedUrl" placeholder="https://example.com/feed.zip" />
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
        <button type="button" id="saveFeedBtn">Save/Update feed</button>
        <button type="button" id="deleteFeedBtn" style="color:#b91c1c;border-color:#fca5a5">Delete selected feed</button>
      </div>
    </div>

    <label>Overrides JSON (for the selected feed)</label>
    <input type="file" id="file" accept="application/json" />

    <label>Commit message <span class="muted">(optional)</span></label>
    <input type="text" id="msg" placeholder="chore: update overrides-<slug>.json via admin" />

    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
      <button type="submit" class="primary">Upload overrides for selected feed</button>
      <button type="button" id="previewBtn">Preview JSON</button>
      <button id="clearSaved" type="button">Clear saved form</button>
    </div>
  </form>

  <div id="result" style="margin-top:16px;"></div>
</div>

<script>
  const fnUrl = "/.netlify/functions/upload-overrides";
  const feedsPath = "gtfs-mapper/automation/feeds.json";

  const form = document.getElementById("uploader");
  const result = document.getElementById("result");
  const previewBtn = document.getElementById("previewBtn");
  const fileInput = document.getElementById("file");
  const feedSelect = document.getElementById("feedSelect");
  const refreshFeedsBtn = document.getElementById("refreshFeeds");
  const deleteFeedBtn = document.getElementById("deleteFeedBtn");

  const FIELDS = ["adminKey","commitMessage","feedSlug","feedUrl"];
  const LS_KEY = "gtfs_admin_uploader_v2";
  let lastJsonText = null;
  let feedsCache = [];  // [{slug,url}]

  // ---- Helpers ----
  function saveNow() {
    const bag = {};
    FIELDS.forEach(k => {
      const el = document.getElementById(k);
      if (el) bag[k] = el.value;
    });
    localStorage.setItem(LS_KEY, JSON.stringify(bag));
  }
  function loadSaved() {
    try {
      const saved = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      if (saved.adminKey) document.getElementById("key").value = saved.adminKey;
      if (saved.commitMessage) document.getElementById("msg").value = saved.commitMessage;
      if (saved.feedSlug) document.getElementById("feedSlug").value = saved.feedSlug;
      if (saved.feedUrl) document.getElementById("feedUrl").value = saved.feedUrl;
    } catch {}
  }
  function uiMessage(html, color) {
    result.innerHTML = `<div style="color:${color||'#111'}">${html}</div>`;
  }
  async function callFn(body) {
    const res = await fetch(fnUrl, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let payload; try { payload = JSON.parse(text); } catch { payload = { ok:false, error:text }; }
    if (!res.ok || !payload.ok) throw new Error(payload.error || text);
    return payload;
  }

  // ---- Feeds list ----
  async function loadFeeds() {
    try {
      const key = document.getElementById("key").value.trim();
      const r = await callFn({ key, op:"readFile", path: feedsPath });
      const arr = JSON.parse(r.content || "[]");
      const feeds = Array.isArray(arr) ? arr : (arr.feeds || []);
      feedsCache = feeds.map(x => typeof x === "string" ? { slug:x, url:"" } : x).filter(x=>x && x.slug);
      renderFeedSelect();
    } catch (e) {
      feedsCache = [];
      feedSelect.innerHTML = `<option value="">(no feeds.json or failed to load)</option>`;
    }
  }

  function renderFeedSelect() {
    const cur = feedSelect.value;
    feedSelect.innerHTML = `<option value="">— Select a feed —</option>` +
      feedsCache.map(f => `<option value="${f.slug}">${f.slug}${f.url ? " — " + f.url : ""}</option>`).join("");
    if (cur) feedSelect.value = cur;
    onFeedChoiceChange();
  }

  function onFeedChoiceChange() {
    const slug = feedSelect.value;
    const found = feedsCache.find(f => f.slug === slug);
    document.getElementById("feedSlug").value = slug || "";
    document.getElementById("feedUrl").value  = found?.url || "";
    saveNow();
  }

  feedSelect.addEventListener("change", onFeedChoiceChange);
  refreshFeedsBtn.addEventListener("click", loadFeeds);

  // ---- Preview ----
  previewBtn.addEventListener("click", async () => {
    const file = fileInput.files?.[0];
    if (!file) { alert("Pick a file first."); return; }
    const text = await file.text();
    lastJsonText = text;
    try {
      const obj = JSON.parse(text);
      result.innerHTML = "<h3>Preview</h3><pre>" + JSON.stringify(obj, null, 2) + "</pre>";
    } catch {
      result.innerHTML = "<div style='color:#b91c1c'>Invalid JSON.</div>";
    }
  });

  // ---- Validate JSON matches selected slug ----
  function normalizeOverridesForSlug(rawObj, slug) {
    // Accept {overrides:{slug:{...}}} OR {slug:{...}}
    const payload = rawObj?.overrides && typeof rawObj.overrides === "object"
      ? rawObj.overrides
      : rawObj;

    if (!payload || typeof payload !== "object") {
      throw new Error("JSON must be an object with either {overrides:{<slug>:{...}}} or {<slug>:{...}}.");
    }
    const keys = Object.keys(payload);
    if (keys.length === 0) throw new Error("No overrides found.");
    if (keys.length > 1) throw new Error(`Found multiple slugs in JSON (${keys.join(", ")}). Keep only the selected feed (${slug}).`);

    const only = keys[0];
    if (only !== slug) throw new Error(`Slug mismatch. Selected "${slug}", but JSON contains "${only}".`);
    const data = payload[only] || {};
    return { [slug]: data };
  }

  // ---- Upload handler ----
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const key  = document.getElementById("key").value.trim();
      const slug = (feedSelect.value || document.getElementById("feedSlug").value || "").trim();
      if (!slug) throw new Error("Pick or enter a feed slug first.");

      const msg = document.getElementById("msg").value.trim();
      const file = fileInput.files?.[0];
      if (!file) throw new Error("Pick an overrides JSON file.");

      const txt = lastJsonText || await file.text();
      let parsed; try { parsed = JSON.parse(txt); } catch { throw new Error("Invalid JSON file."); }
      const normalized = normalizeOverridesForSlug(parsed, slug);
      const overridesJson = JSON.stringify({ overrides: normalized }, null, 2);
      const targetPath = `gtfs-mapper/automation/overrides-${slug}.json`;

      const payload = await callFn({
        key,
        op: "writeFile",
        path: targetPath,
        content: overridesJson,
        commitMessage: msg || `chore: update overrides-${slug}.json via admin`
      });

      uiMessage(`
        <div>✅ Uploaded.</div>
        <ul>
          <li>Path: <code>${payload.path}</code></li>
          <li>Branch: <code>${payload.branch}</code></li>
          <li>Commit: <code>${payload.commit}</code></li>
          ${payload.html_url ? `<li><a target="_blank" href="${payload.html_url}">View on GitHub</a></li>` : ""}
        </ul>
        <p class="muted">Workflows listening to overrides-* will pick this up.</p>
      `, "#065f46");
    } catch (err) {
      uiMessage(`<strong>Error:</strong><pre>${(err && err.message) || err}</pre>`, "#b91c1c");
    }
  });

  // ---- Save/Update feed (existing behavior, just refreshed) ----
  document.getElementById("saveFeedBtn").addEventListener("click", async () => {
    try {
      const key = document.getElementById("key").value.trim();
      const slug = document.getElementById("feedSlug").value.trim();
      const url  = document.getElementById("feedUrl").value.trim();
      if (!slug || !url) throw new Error("Both slug and feed URL are required to save.");

      // Pull current feeds.json, merge/replace, push back
      const r = await callFn({ key, op:"readFile", path: feedsPath });
      let current = []; try { const p = JSON.parse(r.content||"[]"); current = Array.isArray(p) ? p : (p.feeds||[]); } catch {}
      if (!Array.isArray(current)) current = [];

      const idx = current.findIndex(x => (x?.slug||x) === slug);
      if (idx >= 0) {
        const o = typeof current[idx] === "string" ? { slug: current[idx], url } : { ...current[idx], url };
        current[idx] = o;
      } else {
        current.push({ slug, url });
      }

      const payload = await callFn({
        key, op: "writeFile", path: feedsPath,
        content: JSON.stringify(current, null, 2),
        commitMessage: `chore: update feeds.json (${slug})`
      });

      uiMessage(`✅ Saved ${slug}. Commit: <code>${payload.commit}</code>`, "#065f46");
      await loadFeeds();
      if (!feedSelect.value) feedSelect.value = slug;
      onFeedChoiceChange();
    } catch (err) {
      uiMessage(`<strong>Error:</strong><pre>${(err && err.message) || err}</pre>`, "#b91c1c");
    }
  });

  // ---- Delete selected feed (and overrides) ----
  deleteFeedBtn.addEventListener("click", async () => {
    try {
      const key = document.getElementById("key").value.trim();
      const slug = (feedSelect.value || "").trim();
      if (!slug) throw new Error("Select a feed from the dropdown first.");
      if (!confirm(`Delete feed "${slug}"?\nThis will remove it from feeds.json and delete its overrides.`)) return;

      // 1) Load feeds.json and remove slug
      const r = await callFn({ key, op:"readFile", path: feedsPath });
      let current = []; try { const p = JSON.parse(r.content||"[]"); current = Array.isArray(p) ? p : (p.feeds||[]); } catch {}
      const next = current.filter(x => (x?.slug||x) !== slug);

      // 2) Commit feeds.json
      await callFn({
        key, op: "writeFile", path: feedsPath,
        content: JSON.stringify(next, null, 2),
        commitMessage: `chore: remove feed ${slug} from feeds.json`
      });

      // 3) Delete per-feed overrides file (if present)
      await callFn({ key, op:"deleteFile", path:`gtfs-mapper/automation/overrides-${slug}.json` }).catch(()=>{});

      // 4) Remove slug from legacy automation/overrides.json (if present)
      await callFn({ key, op:"deleteSlugFromOverrides", slug, path:"gtfs-mapper/automation/overrides.json" }).catch(()=>{});

      uiMessage(`🗑️ Deleted feed "${slug}" and its overrides.`, "#7c2d12");
      await loadFeeds();
      feedSelect.value = "";
      onFeedChoiceChange();
    } catch (err) {
      uiMessage(`<strong>Error:</strong><pre>${(err && err.message) || err}</pre>`, "#b91c1c");
    }
  });

  // ---- Local storage + init ----
  window.addEventListener("DOMContentLoaded", async () => {
    loadSaved();
    ["key","msg","feedSlug","feedUrl"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", saveNow);
    });
    document.getElementById("clearSaved")?.addEventListener("click", () => {
      localStorage.removeItem(LS_KEY);
      ["key","msg","feedSlug","feedUrl"].forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
    });
    await loadFeeds();
  });
</script>