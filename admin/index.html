<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GTFS Admin — Feeds & Overrides</title>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 720px; margin: 32px auto; padding: 0 16px; }
  .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
  label { display: block; margin: 12px 0 6px; font-weight: 600; }
  input[type="password"], input[type="text"], textarea { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; }
  button { padding: 8px 14px; border-radius: 8px; border: 1px solid #d1d5db; cursor: pointer; background: white; }
  button.primary { background: #0ea5e9; color: white; border-color: #0284c7; }
  .muted { color: #6b7280; font-size: 13px; }
  pre { background: #f8fafc; padding: 12px; border-radius: 8px; overflow: auto; }
</style>

<h1>GTFS Admin — Upload <code>overrides.json</code></h1>
<p class="muted">This commits to your GitHub repo and triggers the nightly Action.</p>

<div class="card">
  <form id="uploader">
    <label>Admin key</label>
    <input type="password" id="key" placeholder="Your ADMIN_KEY" required />

    <!-- <label>Public site base URL</label>
    <input type="text" id="siteBase" placeholder="https://alvarotrabanco.github.io/gtfs-mapper" />
    <p class="muted">Where <code>feeds.json</code> and <code>registry.json</code> are published (your GitHub Pages site).</p> -->

    <label>Feed</label>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="feedSelect" style="flex:1 1 260px;"></select>
      <button type="button" id="refreshFeeds">Reload</button>
    </div>
    <p class="muted">Pick an existing feed or create a new one below.</p>

    <div class="card" style="margin:12px 0;">
      <strong>Overrides target</strong>
      <label style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <input type="radio" name="ovTarget" value="perSlug" checked /> per-slug file (overrides-<slug>.json)
      </label>
      <label style="display:flex;gap:8px;align-items:center;">
        <input type="radio" name="ovTarget" value="global" /> global file (overrides.json)
      </label>
    </div>

    <label>Overrides JSON (for the selected feed)</label>
    <input type="file" id="file" accept="application/json" />

    <label>Commit message <span class="muted">(optional)</span></label>
    <input type="text" id="msg" placeholder="chore: update overrides-<slug>.json via admin" />

    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
      <button type="submit" class="primary">Upload overrides for selected feed</button>
      <button type="button" id="previewBtn">Preview JSON</button>
      <button id="clearSaved" type="button">Clear saved form</button>
    </div>
  </form>

  <div id="result" style="margin-top:16px;"></div>
</div>

<script>
  // ---- Config ----
  function getFnUrl() {
    return "/.netlify/functions/upload-overrides";
  }
  const feedsPath = "gtfs-mapper/automation/feeds.json";

  // ---- Elements ----
  const form = document.getElementById("uploader");
  const result = document.getElementById("result");
  const previewBtn = document.getElementById("previewBtn");
  const fileInput = document.getElementById("file");
  const feedSelect = document.getElementById("feedSelect");
  const refreshFeedsBtn = document.getElementById("refreshFeeds");
  const deleteFeedBtn = document.getElementById("deleteFeedBtn");

  const LS_KEY = "gtfs_admin_uploader_v2";
  let lastJsonText = null;
  let feedsCache = [];
  let originalSlug = "";

  // ---- LS helpers ----
  function saveNow() {
    try {
      const bag = {
        adminKey: document.getElementById("key")?.value || "",
        commitMessage: document.getElementById("msg")?.value || "",
        feedSlug: document.getElementById("feedSlug")?.value || "",
        feedUrl: document.getElementById("feedUrl")?.value || "",
      };
      localStorage.setItem(LS_KEY, JSON.stringify(bag));
    } catch {}
  }
  function loadSaved() {
    try {
      const s = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      if (s.adminKey) document.getElementById("key").value = s.adminKey;
      if (s.commitMessage) document.getElementById("msg").value = s.commitMessage;
      if (s.feedSlug) document.getElementById("feedSlug").value = s.feedSlug;
      if (s.feedUrl) document.getElementById("feedUrl").value = s.feedUrl;
    } catch {}
  }
  function uiMessage(html, color) {
    result.innerHTML = `<div style="color:${color||'#111'}">${html}</div>`;
  }

  // ---- Backend call ----
  async function callFn(body) {
    const fnUrl = getFnUrl();
    const res = await fetch(fnUrl, {
      method: "POST",
      headers: { "content-type":"application/json" },
      body: JSON.stringify(body)
    });
    const text = await res.text();
    let payload; try { payload = JSON.parse(text); } catch { payload = { ok:false, error:text }; }
    if (!res.ok || !payload.ok) throw new Error(payload.error || text);
    return payload;
  }

  // ---- Feeds parsing ----
  function parseFeedsJSON(txt) {
    let j;
    try { j = JSON.parse(txt); } catch { throw new Error("feeds.json is not valid JSON"); }
    if (Array.isArray(j)) {
      return j.map(x => typeof x === "string" ? { slug:x, url:"" } : x).filter(x => x.slug);
    }
    if (j && Array.isArray(j.feeds)) {
      return j.feeds.map(x => typeof x === "string" ? { slug:x, url:"" } : x).filter(x => x.slug);
    }
    if (j && typeof j === "object") {
      return Object.entries(j).map(([k,v]) => ({ slug:k, url: typeof v === "string" ? v : v.url || "" }));
    }
    return [];
  }

  // ---- Load feeds ----
  async function loadFeeds() {
    const key = document.getElementById("key").value.trim();
    let raw = null;
    try {
      const r = await callFn({ key, op:"readFile", path: feedsPath });
      raw = r.content;
    } catch {}
    if (!raw) {
      uiMessage("Feeds not found or unauthorized.", "#b91c1c");
      feedSelect.innerHTML = `<option value="">(no feeds)</option>`;
      return;
    }
    try {
      const parsed = parseFeedsJSON(raw);
      feedsCache = parsed;
      renderFeedSelect();
      uiMessage(`Loaded ${parsed.length} feeds.`, "#065f46");
    } catch (e) {
      uiMessage(`Error parsing feeds.json: ${e.message}`, "#b91c1c");
    }
  }

  function renderFeedSelect() {
    const cur = feedSelect.value;
    feedSelect.innerHTML =
      `<option value="">— Select a feed —</option>` +
      feedsCache.map(f => `<option value="${f.slug}">${f.slug}${f.url ? " — " + f.url : ""}</option>`).join("");
    if (cur) feedSelect.value = cur;
    onFeedChoiceChange();
  }

  function onFeedChoiceChange() {
    const slug = feedSelect.value;
    const found = feedsCache.find(f => f.slug === slug);
    document.getElementById("feedSlug").value = slug || "";
    document.getElementById("feedUrl").value  = found?.url || "";
    originalSlug = slug || "";
    saveNow();
  }

  feedSelect.addEventListener("change", onFeedChoiceChange);
  refreshFeedsBtn.addEventListener("click", loadFeeds);

  // ---- Preview ----
  previewBtn.addEventListener("click", async () => {
    const file = fileInput.files?.[0];
    if (!file) { alert("Pick a file first."); return; }
    const text = await file.text();
    lastJsonText = text;
    try {
      const obj = JSON.parse(text);
      result.innerHTML = "<h3>Preview</h3><pre>" + JSON.stringify(obj, null, 2) + "</pre>";
    } catch {
      result.innerHTML = "<div style='color:#b91c1c'>Invalid JSON.</div>";
    }
  });

  // ---- Normalize overrides ----
  function normalizeOverridesForSlug(rawObj, slug) {
    if (!rawObj || typeof rawObj !== "object") throw new Error("Overrides must be a JSON object.");
    if (rawObj.overrides && typeof rawObj.overrides === "object") {
      const o = rawObj.overrides;
      if (o[slug]) return { [slug]: o[slug] };
      throw new Error(`Slug mismatch. Selected "${slug}", found ${Object.keys(o).join(", ")}.`);
    }
    if (rawObj[slug]) return { [slug]: rawObj[slug] };
    return { [slug]: rawObj };
  }

  // ---- Global overrides helper ----
  async function upsertGlobalOverride({ key, slug, body, msg }) {
    const p = "gtfs-mapper/automation/overrides.json";
    let current = { overrides: {} };
    try {
      const r = await callFn({ key, op:"readFile", path: p });
      const j = JSON.parse(r.content || "{}");
      current = j && typeof j === "object" ? j : current;
      if (!current.overrides || typeof current.overrides !== "object") current.overrides = {};
    } catch {}
    current.overrides[slug] = body || {};
    return await callFn({
      key,
      op: "writeFile",
      path: p,
      content: JSON.stringify(current, null, 2),
      commitMessage: msg || `chore: upsert ${slug} in overrides.json via admin`
    });
  }

  // ---- Upload overrides ----
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    try {
      const key  = document.getElementById("key").value.trim();
      const slug = (feedSelect.value || document.getElementById("feedSlug").value || "").trim();
      if (!key) throw new Error("ADMIN_KEY is required.");
      if (!slug) throw new Error("Pick or enter a feed slug.");
      const msg  = document.getElementById("msg").value.trim();
      const file = fileInput.files?.[0];
      if (!file) throw new Error("Pick an overrides JSON file.");

      const txt = lastJsonText || await file.text();
      const parsed = JSON.parse(txt);
      const normalized = normalizeOverridesForSlug(parsed, slug);
      const targetChoice = document.querySelector('input[name="ovTarget"]:checked')?.value || "perSlug";
      let targetPath;

      if (targetChoice === "global") {
        targetPath = "gtfs-mapper/automation/overrides.json";
        const payload = await upsertGlobalOverride({
          key,
          slug,
          body: normalized[slug] || {},
          msg
        });
        uiMessage(`Uploaded into <code>${targetPath}</code> for <code>${slug}</code>. Commit: <code>${payload.commit || "OK"}</code>`, "#065f46");
      } else {
        targetPath = `gtfs-mapper/automation/overrides-${slug}.json`;
        const payload = await callFn({
          key,
          op: "writeFile",
          path: targetPath,
          content: JSON.stringify({ overrides: normalized }, null, 2),
          commitMessage: msg || `chore: update overrides-${slug}.json via admin`
        });
        uiMessage(`Uploaded per-slug file <code>${targetPath}</code>. Commit: <code>${payload.commit}</code>`, "#065f46");
      }
    } catch (err) {
      uiMessage(`<strong>Error:</strong><pre>${(err && err.message) || err}</pre>`, "#b91c1c");
    }
  });

  // ---- Save/Update feed ----
  document.getElementById("saveFeedBtn").addEventListener("click", async () => {
    try {
      const key = document.getElementById("key").value.trim();
      const newSlug = document.getElementById("feedSlug").value.trim();
      const url  = document.getElementById("feedUrl").value.trim();
      if (!key) throw new Error("ADMIN_KEY is required.");
      if (!newSlug || !url) throw new Error("Both slug and feed URL are required.");

      const r = await callFn({ key, op:"readFile", path: feedsPath });
      let current = []; try { const p = JSON.parse(r.content||"[]"); current = Array.isArray(p) ? p : (p.feeds||[]); } catch {}
      if (!Array.isArray(current)) current = [];

      // rename if slug changed
      if (originalSlug && originalSlug !== newSlug) {
        await callFn({
          key, op:"moveFile",
          src:`gtfs-mapper/automation/overrides-${originalSlug}.json`,
          dest:`gtfs-mapper/automation/overrides-${newSlug}.json`,
          commitMessage:`chore: rename overrides file ${originalSlug} -> ${newSlug}`
        }).catch(()=>{});
        await callFn({
          key, op:"renameSlugInOverrides", slug: originalSlug, newSlug
        }).catch(()=>{});
        current = current.filter(x => (x?.slug||x) !== originalSlug);
      }

      const idx = current.findIndex(x => (x?.slug||x) === newSlug);
      if (idx >= 0) current[idx] = { slug:newSlug, url };
      else current.push({ slug:newSlug, url });

      const payload = await callFn({
        key, op: "writeFile", path: feedsPath,
        content: JSON.stringify(current, null, 2),
        commitMessage: `chore: update feeds.json (${newSlug})`
      });

      uiMessage(`Saved ${newSlug}. Commit: <code>${payload.commit}</code>`, "#065f46");
      originalSlug = newSlug;
      await loadFeeds();
      feedSelect.value = newSlug;
      onFeedChoiceChange();
    } catch (err) {
      uiMessage(`<strong>Error:</strong><pre>${(err && err.message) || err}</pre>`, "#b91c1c");
    }
  });

  // ---- Delete feed ----
  deleteFeedBtn.addEventListener("click", async () => {
    try {
      const key = document.getElementById("key").value.trim();
      const slug = (feedSelect.value || "").trim();
      if (!key) throw new Error("ADMIN_KEY is required.");
      if (!slug) throw new Error("Select a feed first.");
      if (!confirm(`Delete feed "${slug}"?\nThis removes it from feeds.json and deletes overrides-${slug}.json`)) return;

      const r = await callFn({ key, op:"readFile", path: feedsPath });
      let current = []; try { const p = JSON.parse(r.content||"[]"); current = Array.isArray(p) ? p : (p.feeds||[]); } catch {}
      const next = current.filter(x => (x?.slug||x) !== slug);

      await callFn({
        key, op: "writeFile", path: feedsPath,
        content: JSON.stringify(next, null, 2),
        commitMessage: `chore: remove feed ${slug} from feeds.json`
      });
      await callFn({ key, op:"deleteFile", path:`gtfs-mapper/automation/overrides-${slug}.json` }).catch(()=>{});
      await callFn({ key, op:"deleteSlugFromOverrides", slug, path:"gtfs-mapper/automation/overrides.json" }).catch(()=>{});

      uiMessage(`Deleted "${slug}" and its overrides.`, "#7c2d12");
      await loadFeeds();
      feedSelect.value = "";
      onFeedChoiceChange();
    } catch (err) {
      uiMessage(`<strong>Error:</strong><pre>${(err && err.message) || err}</pre>`, "#b91c1c");
    }
  });

  // ---- Init ----
  window.addEventListener("DOMContentLoaded", async () => {
    loadSaved();
    ["key","msg","feedSlug","feedUrl"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", saveNow);
    });
    document.getElementById("clearSaved")?.addEventListener("click", () => {
      localStorage.removeItem(LS_KEY);
      ["key","msg","feedSlug","feedUrl"].forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
    });
    await loadFeeds();
  });
</script>