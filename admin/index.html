<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GTFS Admin — Feeds & Overrides</title>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 720px; margin: 32px auto; padding: 0 16px; }
  .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
  label { display: block; margin: 12px 0 6px; font-weight: 600; }
  input[type="password"], input[type="text"], textarea { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px; }
  button { padding: 8px 14px; border-radius: 8px; border: 1px solid #d1d5db; cursor: pointer; background: white; }
  button.primary { background: #0ea5e9; color: white; border-color: #0284c7; }
  .muted { color: #6b7280; font-size: 13px; }
  pre { background: #f8fafc; padding: 12px; border-radius: 8px; overflow: auto; }
</style>

<!-- ############ LOGIN GATE ############ -->
<script>
(() => {
  const fnUrl = "/.netlify/functions/upload-overrides";
  const feedsPath = "gtfs-mapper/automation/feeds.json";

  const all = Array.from(document.body.children);
  all.forEach(el => el.style.display = "none");

  const gate = document.createElement("div");
  gate.style.cssText = "max-width:400px;margin:80px auto;text-align:center;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif";
  gate.innerHTML = `
    <h1 style="margin:0 0 8px">GTFS Admin Login</h1>
    <p style="color:#6b7280;margin:0 0 16px">Enter your ADMIN_KEY to continue</p>
    <input id="adminKeyInput" type="password" placeholder="ADMIN_KEY"
           style="width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px">
    <button id="adminLoginBtn"
            style="margin-top:12px;padding:8px 14px;border:1px solid #d1d5db;border-radius:8px;cursor:pointer;background:white">
      Login
    </button>
    <div id="adminLoginMsg" style="margin-top:8px;font-size:13px;color:#b91c1c"></div>
  `;
  document.body.appendChild(gate);

  async function verify(key) {
    const msg = document.getElementById("adminLoginMsg");
    msg.style.color = "#111";
    msg.textContent = "Verifying…";
    try {
      const res = await fetch(fnUrl, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ key, op: "readFile", path: feedsPath })
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      if (!data.ok && !data.content) throw new Error("Invalid response");
      localStorage.setItem("GTFS_ADMIN_KEY", key);
      document.body.removeChild(gate);
      all.forEach(el => el.style.display = "");
      const keyInput = document.getElementById("key");
      if (keyInput) keyInput.value = key;
      if (typeof loadFeeds === "function") loadFeeds();
    } catch {
      msg.style.color = "#b91c1c";
      msg.textContent = "Invalid key or server error.";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("adminLoginBtn").addEventListener("click", () => {
      const k = document.getElementById("adminKeyInput").value.trim();
      if (!k) {
        document.getElementById("adminLoginMsg").textContent = "Please enter a key.";
        return;
      }
      verify(k);
    });
    const saved = localStorage.getItem("GTFS_ADMIN_KEY");
    if (saved) verify(saved);
  });
})();
</script>
<!-- #################################### -->

<h1>GTFS Admin — Upload <code>overrides.json</code></h1>
<p class="muted">This commits to your GitHub repo and triggers the nightly Action.</p>

<div class="card">
  <form id="uploader">
    <label>Admin key</label>
    <input type="password" id="key" placeholder="Your ADMIN_KEY" required />

    <label>Public site base URL</label>
    <input type="text" id="siteBase" placeholder="https://alvarotrabanco.github.io/gtfs-mapper" />
    <p class="muted">Where <code>feeds.json</code> and <code>registry.json</code> are published (your GitHub Pages site).</p>

    <label>Feed</label>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="feedSelect" style="flex:1 1 260px;"></select>
      <button type="button" id="refreshFeeds">Reload</button>
    </div>
    <p class="muted">Pick an existing feed or create a new one below.</p>

    <div class="card" style="margin:12px 0;">
      <strong>Add / Update feed</strong>
      <label>Feed slug</label>
      <input type="text" id="feedSlug" placeholder="e.g. flixbus" />
      <label>Feed URL</label>
      <input type="text" id="feedUrl" placeholder="https://example.com/feed.zip" />
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
        <button type="button" id="saveFeedBtn">Save/Update feed</button>
        <button type="button" id="deleteFeedBtn" style="color:#b91c1c;border-color:#fca5a5">Delete selected feed</button>
      </div>
    </div>

    <label>Overrides JSON (for the selected feed)</label>
    <input type="file" id="file" accept="application/json" />

    <label>Commit message <span class="muted">(optional)</span></label>
    <input type="text" id="msg" placeholder="chore: update overrides-<slug>.json via admin" />

    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
      <button type="submit" class="primary">Upload overrides for selected feed</button>
      <button type="button" id="previewBtn">Preview JSON</button>
      <button id="clearSaved" type="button">Clear saved form</button>
    </div>
  </form>

  <div id="result" style="margin-top:16px;"></div>
</div>

<!-- your existing long admin script -->
<script src="admin-ui.js"></script>